<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام صيدلية حياة - إصدار Gemini 2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4834d4; --success: #2ecc71; --bg: #f4f7f6; }
        body { font-family: 'Changa', sans-serif; background: var(--bg); margin: 0; text-align: center; }
        .container { padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: inline-block; min-width: 350px; }
        .btn { background: var(--primary); color: white; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-family: 'Changa'; }
        #loader { display: none; margin-top: 20px; color: var(--primary); font-weight: bold; }
        table { width: 100%; margin-top: 30px; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2><i class="fas fa-robot"></i> صيدلية حياة - تحليل ذكي</h2>
        <p>ارفع فاتورة المذخر ليقوم <b>Gemini 2.0 Flash</b> بمعالجتها</p>
        <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="analyzeInvoice(this)">
        <button class="btn" onclick="document.getElementById('imageInput').click()">اختر صورة الفاتورة</button>
        <div id="loader">⏳ جاري التحليل باستخدام Gemini 2.0...</div>
    </div>

    <table id="resultTable" style="display:none">
        <thead>
            <tr><th>اسم الدواء</th><th>الكمية</th><th>السعر</th></tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
    </table>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // مفتاحك الذي قمت بتجربته بنجاح
    const API_KEY = "AIzaSyCZ7lb3L4WUXTTUCUUS4t5hpjvuu8TR7Fk";
    const genAI = new GoogleGenerativeAI(API_KEY);

    window.analyzeInvoice = async (input) => {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loader').style.display = 'block';
        document.getElementById('resultTable').style.display = 'none';

        try {
            const base64 = await toBase64(file);
            
            // استدعاء موديل 2.0 فلاش كما في الـ Curl الخاص بك
            const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

            const prompt = "Extract medicines from this invoice. Return ONLY a JSON array of objects: [{\"name\":\"string\", \"qty\":number, \"price\":number}]. No conversational text.";

            const result = await model.generateContent([
                { inlineData: { data: base64.split(',')[1], mimeType: file.type } },
                { text: prompt }
            ]);

            const response = await result.response;
            const text = response.text();
            
            // استخراج الـ JSON وتنظيفه
            const jsonStr = text.substring(text.indexOf('['), text.lastIndexOf(']') + 1);
            const data = JSON.parse(jsonStr);

            renderData(data);
        } catch (error) {
            console.error(error);
            alert("حدث خطأ أثناء التحليل. تأكد من وضوح الصورة.");
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    };

    function renderData(items) {
        const body = document.getElementById('inventoryBody');
        body.innerHTML = items.map(item => `
            <tr>
                <td>${item.name}</td>
                <td>${item.qty}</td>
                <td>${item.price.toLocaleString()} د.ع</td>
            </tr>
        `).join('');
        document.getElementById('resultTable').style.display = 'table';
    }

    const toBase64 = file => new Promise((res, rej) => {
        const r = new FileReader(); r.readAsDataURL(file);
        r.onload = () => res(r.result); r.onerror = e => rej(e);
    });
</script>

</body>
</html>
